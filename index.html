<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>VR Classroom - Exposure Therapy</title>
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <style>
        :root {
            --color-text: rgba(19, 52, 59, 1);
            --color-background: rgba(252, 252, 249, 1);
            --color-primary: rgba(33, 128, 141, 1);
            --color-primary-hover: rgba(29, 116, 128, 1);
            --color-secondary: rgba(94, 82, 64, 0.12);
            --color-border: rgba(94, 82, 64, 0.2);
            --font-family-base: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        }

        body {
            margin: 0;
            font-family: var(--font-family-base);
            background: linear-gradient(135deg, #E8F4F8 0%, #F0F8FA 100%);
            color: var(--color-text);
            min-height: 100vh;
        }

        /* Screen Container */
        .screen {
            display: none;
            min-height: 100vh;
            padding: 40px 20px;
            animation: fadeIn 0.5s ease-in-out;
        }

        .screen.active {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Card Container */
        .card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            padding: 40px;
            max-width: 600px;
            width: 100%;
        }

        /* Typography */
        h1 {
            font-size: 32px;
            margin: 0 0 16px 0;
            color: var(--color-text);
            font-weight: 600;
        }

        h2 {
            font-size: 24px;
            margin: 0 0 12px 0;
            color: var(--color-text);
            font-weight: 600;
        }

        /* VR Overlay Typography Overrides */
        .overlay-card h1 {
            font-size: 20px;
            margin: 0 0 12px 0;
        }

        .overlay-card h2 {
            font-size: 18px;
            margin: 0 0 10px 0;
        }

        .overlay-card p {
            font-size: 13px;
            line-height: 1.4;
            margin: 0 0 12px 0;
        }

        .overlay-card .btn {
            padding: 10px 16px;
            font-size: 13px;
        }

        .overlay-card .conversation-display {
            max-height: 180px;
            padding: 12px;
            margin: 12px 0;
        }

        .overlay-card .message {
            margin-bottom: 10px;
            padding: 8px;
            font-size: 12px;
        }

        .overlay-card .voice-status {
            font-size: 11px;
            margin-top: 6px;
        }

        .overlay-card .icon {
            font-size: 32px;
            margin-bottom: 12px;
        }

        .overlay-card ul {
            font-size: 12px;
            margin: 8px 0;
            padding-left: 16px;
        }

        .overlay-card li {
            margin-bottom: 4px;
        }

        p {
            font-size: 16px;
            line-height: 1.6;
            color: rgba(19, 52, 59, 0.8);
            margin: 0 0 20px 0;
        }

        /* Progress Bar */
        .progress-container {
            margin-bottom: 30px;
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: var(--color-secondary);
            border-radius: 3px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: var(--color-primary);
            transition: width 0.3s ease;
        }

        .progress-text {
            font-size: 14px;
            color: rgba(19, 52, 59, 0.6);
            margin-top: 8px;
            text-align: center;
        }

        /* Form Elements */
        .form-group {
            margin-bottom: 24px;
        }

        label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 8px;
            color: var(--color-text);
        }

        input, select, textarea {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--color-border);
            border-radius: 8px;
            font-size: 16px;
            font-family: var(--font-family-base);
            transition: border-color 0.2s;
            box-sizing: border-box;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--color-primary);
        }

        textarea {
            resize: vertical;
            min-height: 100px;
        }

        /* Buttons */
        .btn {
            padding: 14px 28px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            font-family: var(--font-family-base);
        }

        .btn-primary {
            background: var(--color-primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--color-primary-hover);
        }

        .btn-secondary {
            background: var(--color-secondary);
            color: var(--color-text);
        }

        .btn-secondary:hover {
            background: rgba(94, 82, 64, 0.2);
        }

        .btn-voice {
            background: #FF6B6B;
            color: white;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-voice:hover {
            background: #EE5A5A;
        }

        .btn-voice.listening {
            background: #51CF66;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .btn-group {
            display: flex;
            gap: 12px;
            margin-top: 24px;
        }

        .btn-full {
            width: 100%;
        }

        /* Voice Conversation */
        .voice-conversation {
            text-align: center;
        }

        .conversation-display {
            background: var(--color-secondary);
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            max-height: 300px;
            overflow-y: auto;
            text-align: left;
        }

        .message {
            margin-bottom: 16px;
            padding: 12px;
            border-radius: 8px;
            animation: messageSlideIn 0.3s ease-out;
        }

        .system-message {
            background: rgba(33, 128, 141, 0.1);
            border-left: 4px solid var(--color-primary);
        }

        .user-message {
            background: rgba(94, 82, 64, 0.1);
            border-left: 4px solid rgba(94, 82, 64, 0.8);
        }

        @keyframes messageSlideIn {
            from { opacity: 0; transform: translateX(-10px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .voice-controls {
            margin: 20px 0;
        }

        .conversation-info {
            background: rgba(33, 128, 141, 0.05);
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }

        /* Voice Input Section */
        .voice-section {
            background: var(--color-secondary);
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            text-align: center;
        }

        .voice-status {
            font-size: 14px;
            color: rgba(19, 52, 59, 0.7);
            margin-top: 8px;
        }

        /* Session Summary */
        .summary-item {
            padding: 12px;
            background: var(--color-secondary);
            border-radius: 8px;
            margin-bottom: 12px;
        }

        .summary-item strong {
            display: block;
            margin-bottom: 4px;
            font-size: 14px;
        }

        .summary-item span {
            font-size: 16px;
            color: var(--color-text);
        }

        /* VR Scene (hidden initially) */
        #vr-container {
            display: none;
        }

        #vr-container.active {
            display: block;
        }

        /* Icons */
        .icon {
            font-size: 48px;
            margin-bottom: 20px;
        }

        /* Alert */
        .alert {
            background: rgba(33, 128, 141, 0.1);
            border-left: 4px solid var(--color-primary);
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .alert p {
            margin: 0;
            font-size: 14px;
        }

        /* VR Overlay Styles */
        .vr-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(8px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
            overflow-y: auto;
        }

        .vr-overlay.active {
            display: flex;
        }

        .overlay-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.25);
            padding: 24px;
            max-width: 420px;
            width: 90%;
            max-height: 75vh;
            overflow-y: auto;
            animation: overlaySlideIn 0.5s ease-out;
            font-size: 14px;
        }

        @keyframes overlaySlideIn {
            from { 
                opacity: 0; 
                transform: scale(0.9) translateY(20px); 
            }
            to { 
                opacity: 1; 
                transform: scale(1) translateY(0); 
            }
        }

        /* Manual input overlay */
        .manual-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(8px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1001;
            padding: 20px;
            overflow-y: auto;
        }

        .manual-overlay.active {
            display: flex;
        }
    </style>
</head>
<body>
    <!-- Welcome Screen (hidden - now using VR overlay) -->
    <div id="screen-welcome" class="screen">
        <div class="card">
            <div class="icon">🎓</div>
            <h1>Virtual Lecter's Destressing Experience</h1>
            
            <div class="voice-conversation">
                <div class="conversation-display" id="conversation-display">
                    <div class="message system-message">
                        <strong>System:</strong> Welcome to Virtual Lecter's Destressing Experience
                    </div>
                </div>
                
                <div class="voice-controls">
                    <button class="btn btn-voice btn-full" id="main-voice-btn" onclick="startConversation()">
                        🎤 Click to Start Voice Conversation
                    </button>
                    <div class="voice-status" id="main-voice-status">Ready to begin</div>
                </div>
                
                <div class="conversation-info">
                    <p><strong>How this works:</strong></p>
                    <ul style="text-align: left; line-height: 1.6;">
                        <li>The system will speak to you</li>
                        <li>You respond with your voice</li>
                        <li>Say "yes" or "thank you" to continue</li>
                        <li>We'll collect basic information for safety</li>
                        <li><strong>Speak within 10 seconds after listening starts</strong></li>
                    </ul>
                    
                    <div style="background: rgba(255, 107, 107, 0.1); padding: 12px; border-radius: 6px; margin-top: 16px;">
                        <p style="margin: 0; font-size: 14px;"><strong>⚠️ Microphone Permission Required:</strong></p>
                        <p style="margin: 8px 0 0 0; font-size: 13px;">
                            When you click the button, your browser will ask for microphone access. 
                            Look for a popup near the address bar and click "Allow".
                        </p>
                    </div>
                </div>
                
                <button class="btn btn-secondary btn-full" onclick="skipToManualMode()" style="margin-top: 20px;">
                    Skip Voice Mode (Use Manual Input)
                </button>
            </div>
        </div>
    </div>

    <!-- Manual Input Overlay for Information Collection -->
    <div id="manual-overlay" class="manual-overlay">
        <div class="overlay-card">
            <h2>Basic Information</h2>
            <p>Let's collect some basic information to personalize your experience.</p>

            <div class="form-group">
                <label for="manual-name">Your Name (or Participant ID)</label>
                <input type="text" id="manual-name" placeholder="Enter your name" />
            </div>

            <div class="form-group">
                <label for="manual-age">Age</label>
                <input type="number" id="manual-age" placeholder="Enter your age" min="5" max="100" />
            </div>

            <div class="form-group">
                <label for="manual-anxiety">Current Anxiety Level (1-10)</label>
                <input type="range" id="manual-anxiety" min="1" max="10" value="5" oninput="updateManualAnxietyDisplay()" />
                <div style="text-align: center; font-size: 18px; margin-top: 8px;">
                    <strong id="manual-anxiety-display">5</strong> / 10
                </div>
            </div>

            <div class="form-group">
                <label for="manual-goals">Session Goals</label>
                <textarea id="manual-goals" placeholder="What would you like to work on today?"></textarea>
            </div>

            <div class="btn-group">
                <button class="btn btn-secondary" onclick="closeManualOverlay()">Back</button>
                <button class="btn btn-primary" onclick="submitManualData()" style="flex: 1;">Start VR Experience</button>
            </div>
        </div>
    </div>
    
    <!-- Information Collection Screen (deprecated) -->
    <div id="screen-info" class="screen" style="display: none;">
        <div class="card">
            <div class="progress-container">
                <div class="progress-bar">
                    <div class="progress-fill" style="width: 25%"></div>
                </div>
                <div class="progress-text">Step 1 of 4</div>
            </div>
            
            <h2>Basic Information</h2>
            <p>Let's collect some basic information to personalize your experience.</p>

            <div class="form-group">
                <label for="participant-name">Your Name (or Participant ID)</label>
                <div style="display: flex; gap: 8px;">
                    <input type="text" id="participant-name" placeholder="Enter your name" />
                    <button class="btn btn-voice" onclick="startVoiceInput('participant-name')">
                        🎤
                    </button>
                </div>
            </div>

            <div class="form-group">
                <label for="participant-age">Age</label>
                <input type="number" id="participant-age" placeholder="Enter your age" min="5" max="100" />
            </div>

            <div class="form-group">
                <label for="anxiety-level">Current Anxiety Level (1-10)</label>
                <input type="range" id="anxiety-level" min="1" max="10" value="5" oninput="updateAnxietyDisplay()" />
                <div style="text-align: center; font-size: 18px; margin-top: 8px;">
                    <strong id="anxiety-display">5</strong> / 10
                </div>
            </div>

            <div class="btn-group">
                <button class="btn btn-secondary" onclick="goToScreen('welcome')">Back</button>
                <button class="btn btn-primary" onclick="goToScreen('goals')" style="flex: 1;">Next</button>
            </div>
        </div>
    </div>

    <!-- Session Goals Screen -->
    <div id="screen-goals" class="screen">
        <div class="card">
            <div class="progress-container">
                <div class="progress-bar">
                    <div class="progress-fill" style="width: 50%"></div>
                </div>
                <div class="progress-text">Step 2 of 4</div>
            </div>
            
            <h2>Session Goals</h2>
            <p>What would you like to work on today? You can type or use voice input.</p>

            <div class="voice-section">
                <button class="btn btn-voice" id="goals-voice-btn" onclick="startVoiceInput('session-goals')">
                    🎤 Click to Speak
                </button>
                <div class="voice-status" id="goals-voice-status">Voice input ready</div>
            </div>

            <div class="form-group">
                <label for="session-goals">Your Goals (e.g., "reduce anxiety when presenting", "feel comfortable in classroom")</label>
                <textarea id="session-goals" placeholder="Describe what you want to achieve..."></textarea>
            </div>

            <div class="form-group">
                <label for="exposure-level">Preferred Exposure Level</label>
                <select id="exposure-level">
                    <option value="gentle">Gentle - Empty classroom, calm environment</option>
                    <option value="moderate">Moderate - Few students, minimal activity</option>
                    <option value="challenging">Challenging - Full classroom, active environment</option>
                </select>
            </div>

            <div class="btn-group">
                <button class="btn btn-secondary" onclick="goToScreen('info')">Back</button>
                <button class="btn btn-primary" onclick="goToScreen('summary')" style="flex: 1;">Next</button>
            </div>
        </div>
    </div>

    <!-- Summary/Ready Screen -->
    <div id="screen-summary" class="screen">
        <div class="card">
            <div class="progress-container">
                <div class="progress-bar">
                    <div class="progress-fill" style="width: 75%"></div>
                </div>
                <div class="progress-text">Step 3 of 4</div>
            </div>
            
            <h2>Session Summary</h2>
            <p>Please review your information before entering the VR environment.</p>

            <div id="summary-content">
                <!-- Populated dynamically -->
            </div>

            <div class="alert">
                <p><strong>Ready to begin?</strong> You'll enter a virtual classroom. You can exit at any time by pressing ESC or removing your headset.</p>
            </div>

            <div class="btn-group">
                <button class="btn btn-secondary" onclick="goToScreen('goals')">Back</button>
                <button class="btn btn-primary" onclick="startVRSession()" style="flex: 1;">Enter VR Classroom</button>
            </div>
        </div>
    </div>

    <!-- VR Container -->
    <div id="vr-container" class="active">
        <!-- Overlay for conversation - appears on top of VR scene -->
        <div id="vr-overlay" class="vr-overlay active">
            <div class="overlay-card">
                <div class="icon">🎓</div>
                <h1>Virtual Lecter's Destressing Experience</h1>

                <div class="voice-conversation">
                    <div class="conversation-display" id="vr-conversation-display">
                        <div class="message system-message">
                            <strong>System:</strong> Welcome to Virtual Lecter's Destressing Experience
                        </div>
                    </div>

                    <div class="voice-controls">
                        <button class="btn btn-voice btn-full" id="vr-voice-btn" onclick="startVRConversation()">
                            🎤 Click to Start Voice Conversation
                        </button>
                        <div class="voice-status" id="vr-voice-status">Ready to begin</div>
                    </div>

                    <div class="conversation-info">
                        <p><strong>How this works:</strong></p>
                        <ul style="text-align: left; line-height: 1.6;">
                            <li>The system will speak to you</li>
                            <li>You respond with your voice</li>
                            <li>Say "yes" or "thank you" to continue</li>
                            <li>We'll collect basic information for safety</li>
                            <li><strong>Speak within 30 seconds after listening starts</strong></li>
                        </ul>
                    </div>

                    <button class="btn btn-secondary btn-full" onclick="skipToManualOverlay()" style="margin-top: 20px;">
                        Skip Voice Mode (Use Manual Input)
                    </button>
                </div>
            </div>
        </div>

        <a-scene>
            <a-sky color="#E8F4F8"></a-sky>
            <a-entity light="type: ambient; color: #BBB; intensity: 0.8"></a-entity>
            <a-entity light="type: directional; color: #FFF; intensity: 0.6" position="5 10 7"></a-entity>
            <a-entity light="type: point; color: #FFF; intensity: 0.4" position="0 3.5 0"></a-entity>

            <a-entity id="classroom-model"
                      gltf-model="https://raw.githubusercontent.com/o-meiuqer-o/classroom_VR4ET/main/assets/models/classroom.glb"
                      position="0 0 0"
                      rotation="0 180 0"
                      scale="1.15 1.15 1.15"
                      shadow="cast: true; receive: true"></a-entity>

            <a-entity id="rig" position="-0.5 0.6 1.8">
                <a-camera id="camera" look-controls wasd-controls>
                    <a-cursor color="#21808D"></a-cursor>
                </a-camera>
            </a-entity>
        </a-scene>
    </div>

<script>
    // Session data storage
    const sessionData = {
        comfortableLanguages: '',
        preferredColor: '',
        emergencyContact: '',
        goals: '',
        exposureLevel: 'gentle',
        startTime: new Date()
    };

    // Web Speech API setup
    let recognition = null;
    let synthesis = window.speechSynthesis;
    let voices = [];
    let recognitionTimeout = null;
    let autoRestartEnabled = false;

    // Load voices
    if (synthesis) {
        synthesis.onvoiceschanged = function() {
            voices = synthesis.getVoices();
            console.log('Voices loaded:', voices.length);
        };
    }

    if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        recognition = new SpeechRecognition();
        recognition.continuous = false;
        recognition.interimResults = true;
        recognition.maxAlternatives = 3;
        recognition.lang = 'en-US';

        console.log('✅ Speech Recognition available');
    } else {
        console.log('❌ Speech Recognition NOT available');
    }

    // Conversation state
    let conversationState = {
        step: 'welcome',
        isListening: false,
        currentQuestion: '',
        responses: {},
        hasReceivedSpeech: false
    };

    // Updated conversation flow with new questions
    const conversationFlow = {
        welcome: {
            text: "Welcome to Virtual Lecter's Destressing Experience. We'll practice safely in a virtual classroom. Before we begin, I will ask a few questions to personalize your experience. Are you ready to start?",
            nextStep: 'language',
            expectedResponses: ['yes', 'okay', 'sure', 'ready', 'thank you']
        },
        language: {
            text: "Which languages are you comfortable with? Feel free to mention one or more.",
            nextStep: 'color',
            saveAs: 'comfortableLanguages'
        },
        color: {
            text: "What is your preferred color for the virtual environment?",
            nextStep: 'emergencyContact',
            saveAs: 'preferredColor'
        },
        emergencyContact: {
            text: "For your safety, please provide the name and phone number of an emergency contact person.",
            nextStep: 'goals',
            saveAs: 'emergencyContact'
        },
        goals: {
            text: "What would you like to work on today? For example, 'reduce anxiety when presenting' or 'feel comfortable in class'.",
            nextStep: 'complete',
            saveAs: 'goals'
        },
        complete: {
            text: "Thank you for sharing. We're now ready to begin your virtual classroom experience. Are you ready to enter the virtual environment?",
            nextStep: 'vr',
            expectedResponses: ['yes', 'ready', 'let\'s go', 'thank you']
        }
    };

    // Mic permission checking and request, speech synthesis, conversation controls, voice recognition event handlers
    // ... existing code unchanged from previous version ...

    // Here the functions `startConversation`, `startListening`, `processVoiceResponse`, `continueConversation`, `addMessageToConversation`, and `completeVoiceConversation` remain the same but will now use updated conversationFlow and saveAs fields

    async function startConversation() {
        const btnId = window.currentVoiceButton || 'main-voice-btn';
        const statusId = window.currentStatusElement || 'main-voice-status';
        const voiceBtn = document.getElementById(btnId);
        const statusEl = document.getElementById(statusId);

        console.log('🎬 Starting/Resuming conversation...');

        const currentStep = conversationState.step || 'welcome';
        const currentFlow = conversationFlow[currentStep];

        if (currentStep !== 'welcome' && conversationState.responses && Object.keys(conversationState.responses).length > 0) {
            voiceBtn.textContent = '🔊 Resuming...';
            statusEl.textContent = 'Resuming conversation';

            Object.keys(conversationState.responses).forEach(key => {
                addMessageToConversation('You', conversationState.responses[key]);
            });

            speak("Let's continue from where we left off. " + currentFlow.text, () => {
                voiceBtn.textContent = '🎤 Listening...';
                voiceBtn.classList.add('listening');
                statusEl.textContent = '🔴 Speak your response';
                startListening(currentStep);
            });
            return;
        }

        voiceBtn.textContent = '🎤 Requesting microphone access...';
        const hasPermission = await requestMicPermission();
        if (!hasPermission) {
            voiceBtn.textContent = '🎤 Click to Start Voice Conversation';
            statusEl.textContent = '❌ Microphone access denied';
            return;
        }

        speak(currentFlow.text, () => {
            voiceBtn.textContent = '🎤 Listening for your response...';
            voiceBtn.classList.add('listening');
            statusEl.textContent = '🔴 LISTENING - Speak now';
            startListening('welcome');
        });
    }

    function processVoiceResponse(transcript, step) {
        const currentFlow = conversationFlow[step];
        if (currentFlow.saveAs) {
            conversationState.responses[currentFlow.saveAs] = transcript;
        }

        if (currentFlow.nextStep === 'vr') {
            completeVoiceConversation();
        } else {
            setTimeout(() => continueConversation(currentFlow.nextStep), 1000);
        }
    }

    function continueConversation(nextStep) {
        const nextFlow = conversationFlow[nextStep];
        const voiceBtn = document.getElementById('main-voice-btn');
        const statusEl = document.getElementById('main-voice-status');

        voiceBtn.textContent = '🔊 Speaking...';
        voiceBtn.classList.remove('listening');
        statusEl.textContent = 'System is speaking';

        speak(nextFlow.text, () => {
            voiceBtn.textContent = '🎤 Listening...';
            voiceBtn.classList.add('listening');
            statusEl.textContent = '🔴 Speak your response';
            startListening(nextStep);
        });
    }

    function addMessageToConversation(sender, message) {
        const displayId = window.currentConversationDisplay || 'conversation-display';
        const conversationDisplay = document.getElementById(displayId);
        if (!conversationDisplay) return;
        const messageDiv = document.createElement('div');
        messageDiv.className = sender === 'System' ? 'message system-message' : 'message user-message';
        messageDiv.innerHTML = `<strong>${sender}:</strong> ${message}`;
        conversationDisplay.appendChild(messageDiv);
        conversationDisplay.scrollTop = conversationDisplay.scrollHeight;
    }

    function completeVoiceConversation() {
        // Save responses to sessionData for summary or processing
        sessionData.comfortableLanguages = conversationState.responses.comfortableLanguages || '';
        sessionData.preferredColor = conversationState.responses.preferredColor || '';
        sessionData.emergencyContact = conversationState.responses.emergencyContact || '';
        sessionData.goals = conversationState.responses.goals || '';
        sessionData.exposureLevel = 'gentle'; // Or from UI if chosen separately

        const voiceBtn = document.getElementById(window.currentVoiceButton || 'main-voice-btn');
        const statusEl = document.getElementById(window.currentStatusElement || 'main-voice-status');

        voiceBtn.textContent = '✅ Complete - Starting VR';
        voiceBtn.classList.remove('listening');
        statusEl.textContent = 'Launching virtual classroom...';

        setTimeout(() => {
            document.getElementById('vr-overlay').classList.remove('active');
            speak('Welcome to the virtual classroom. Take your time and remember you can exit at any moment.');
        }, 2000);
    }

    // Other functions: mic permission, voice recording handlers, manual input handling, UI control remain unchanged from previous code

    // You can keep the rest of the existing code unchanged (voice input, manual input, screens, VR loading)

</script>
</body>
</html>
